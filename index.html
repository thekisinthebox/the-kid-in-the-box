<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>THE KID IN THE BOX</title>
  <link rel="icon" type="image/png" href="img/favicon.png">
  <meta name="description" content="The kid in the box "/>

  <!-- Fonts (preconnect + swap) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet" />

  <style>
    /* === Animated lava GIF background === */
    #lavaBg{
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
      background: url('lava.gif') center / cover no-repeat;
      opacity: .18; image-rendering: pixelated; will-change: opacity;
      mix-blend-mode: normal; /* cheaper than screen */
    }
    @media (max-width: 780px){ #lavaBg{ opacity: .14; } }

    /* === 90s VIBES CORE === */
    :root{ --primary:#00ffea; --accent:#ff00d4; --dark:#0a0020; --panel:#14003a; --lite:#e6e6ff; --link:#00e0ff; }
    html,body{height:100%}
    body{
      margin:0; color:var(--lite); background:#0b0022;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,.20) 0 1px, transparent 2px),
        radial-gradient(circle at 80% 40%, rgba(255,255,255,.15) 0 1px, transparent 2px),
        radial-gradient(circle at 50% 80%, rgba(255,255,255,.12) 0 1px, transparent 2px),
        repeating-linear-gradient(45deg, rgba(255,0,255,.05) 0 4px, rgba(0,255,255,.05) 4px 8px),
        radial-gradient(ellipse at bottom, #0b0022 0%, #060015 70%, #02000a 100%);
      image-rendering: pixelated;
      font-family:'VT323','Pixel',monospace,system-ui,sans-serif;
      -webkit-font-smoothing:none; text-rendering:optimizeSpeed; font-smooth:never;
      cursor:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><polygon points="16,2 19,11 29,11 21,17 24,26 16,20 8,26 11,17 3,11 13,11" fill="%23ff00d4" stroke="%2300ffea" stroke-width="2"/></svg>') 16 2, auto;
    }
    body::after{content:""; position:fixed; inset:0; pointer-events:none; z-index:0; background-image:linear-gradient(rgba(0,0,0,.12) 1px, transparent 1px); background-size:100% 3px; mix-blend-mode:overlay; opacity:.45;}
    body::before{
      content:""; position:fixed; inset:-10%; pointer-events:none; z-index:0;
      background:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.8) 0 1px, transparent 2px),
        radial-gradient(circle at 70% 60%, rgba(255,255,255,.7) 0 1px, transparent 2px),
        radial-gradient(circle at 40% 80%, rgba(255,255,255,.6) 0 1px, transparent 2px);
      animation: drift 30s linear infinite;
    }
    @keyframes drift{0%{transform:translateY(0)}100%{transform:translateY(-20px)}}

    a{color:var(--link); text-decoration:none}
    a:hover{color:#fff; text-shadow:0 0 6px var(--link)}

    .frame{max-width:980px; margin:24px auto; border:4px ridge #9cf; padding:0; box-shadow:0 0 40px #00e0ff55; background:linear-gradient(180deg,#14003a 0,#0a0020 100%); position:relative; z-index:2;}
    header{position:relative; padding:20px 14px; text-align:center; border-bottom:3px groove #b6f;}
    .title{
      font-family:'Press Start 2P',monospace; font-size:clamp(22px,3.2vw,44px); letter-spacing:1.5px; margin:0; text-transform:uppercase;
      background:linear-gradient(90deg,#ff00d4,#00ffea,#fffd37,#ff00d4); background-size:300% 100%;
      -webkit-background-clip:text; background-clip:text; color:transparent; animation:rainbow 8s linear infinite;
    }
    @keyframes rainbow{from{background-position:0 0}to{background-position:300% 0}}

    .news{background:#1b0050; border-top:3px ridge #74f; border-bottom:3px ridge #74f; padding:2px 0}
    .news marquee{font-size:14px}

    .grid{display:grid; grid-template-columns:220px 1fr; gap:0}
    nav{border-right:4px ridge #59e; background:#0d0130; padding:14px}
    nav h3{margin:10px 0; font-size:16px}
    .btn{display:block; margin:8px 0; padding:8px 10px; border:3px outset #58f; background:#001a5e; color:#e6e6ff; text-transform:uppercase; font-weight:bold; box-shadow:inset 0 0 10px #00e0ff44,0 0 6px #00e0ff55; cursor:pointer;}
    .btn:hover{border-style:inset; filter:brightness(1.2)}

    main{padding:18px}
    .card{border:4px groove #8bf; padding:14px; margin:14px 0; background:#120036aa; backdrop-filter:blur(1px)}
    .blink{animation:blink 1.2s steps(2,start) infinite}
    @keyframes blink{to{visibility:hidden}}
    .counter{font-family:monospace; letter-spacing:1px; background:#0008; display:inline-block; padding:4px 6px; border:3px inset #46f}

    footer{text-align:center; padding:10px; font-size:12px; color:#cde; border-top:3px ridge #59e}

    .sparkle{position:fixed; width:6px; height:6px; border-radius:50%; pointer-events:none; mix-blend-mode:screen; opacity:.9}

    @media (max-width:780px){.grid{grid-template-columns:1fr} nav{border-right:0; border-bottom:4px ridge #59e}}

    /* Dancing background character */
    #bgDancer{position:fixed; right:2vw; bottom:0; width:min(38vmin,420px); z-index:1; pointer-events:none; opacity:.28; filter:contrast(110%) saturate(110%)}
    #bgDancer img{width:100%; height:auto; image-rendering:pixelated; transform-origin:50% 100%; animation:dance-bop 1.1s ease-in-out infinite, dance-glow 3.6s linear infinite; animation-play-state:paused; will-change:transform,filter}
    .playing #bgDancer img{animation-play-state:running}
    @keyframes dance-bop{
      0%{transform:translateY(0) rotate(0) scale(1)}
      15%{transform:translateY(-2px) rotate(-1.5deg) scale(1.02)}
      30%{transform:translateY(0) rotate(0) scale(1)}
      50%{transform:translateY(-3px) rotate(1.5deg) scale(1.03)}
      70%{transform:translateY(0) rotate(0) scale(1)}
      85%{transform:translateY(-1px) rotate(-1deg) scale(1.01)}
      100%{transform:translateY(0) rotate(0) scale(1)}
    }
    @keyframes dance-glow{
      0%{filter:contrast(110%) saturate(110%) drop-shadow(0 0 0 rgba(210,77,255,0))}
      50%{filter:contrast(120%) saturate(120%) drop-shadow(0 0 8px rgba(210,77,255,.35))}
      100%{filter:contrast(110%) saturate(110%) drop-shadow(0 0 0 rgba(210,77,255,0))}
    }

    /* Floating eyes */
    #weirdLayer{position:fixed; inset:0; pointer-events:none; z-index:1}
    .eye{position:absolute; width:80px; height:50px; opacity:.6; transform:translate(-50%,-50%) rotate(var(--rot,0deg)); filter:drop-shadow(0 0 6px rgba(255,0,212,.25)); animation:floaty 10s ease-in-out infinite}
    .eye .sclera{position:absolute; inset:0; border-radius:50% / 45%; background:
      radial-gradient(circle at 30% 40%, rgba(255,255,255,.95) 0 30%, rgba(255,255,255,.8) 31% 70%, rgba(180,180,255,.35) 71% 100%);
      border:2px solid rgba(255,255,255,.6)}
    .eye .pupil{--x:0px; --y:0px; position:absolute; width:18px; height:18px; border-radius:50%; top:calc(50% - 9px); left:calc(50% - 9px); transform:translate(var(--x),var(--y));
      background:radial-gradient(circle at 35% 35%, #666 0 20%, #000 21% 60%, #0000 61%), radial-gradient(circle at 50% 50%, #000 0 70%, #0000 71%)}
    @keyframes floaty{0%,100%{transform:translate(-50%,-50%) translateY(0) rotate(var(--rot,0deg))}50%{transform:translate(-50%,-50%) translateY(-10px) rotate(calc(var(--rot,0deg) + 3deg))}}

    .pixel-wrapper{position:relative; width:100%; border:4px ridge #8bf; background:#0d0130; overflow:hidden; aspect-ratio:16/9}
    #pxCanvas{width:100%; height:100%; image-rendering:pixelated; image-rendering:crisp-edges; display:block; background:#080016}

    /* Public Chat theme match */
    #public-chat {--pc-bg:#0d0130; --pc-fg:#e6e6ff; --pc-border:#59e; --pc-shadow:#00e0ff55}
    #public-chat input.chat-input, #public-chat textarea.chat-input, #public-chat input[type="text"], #public-chat textarea{
      background:var(--pc-bg)!important; color:var(--pc-fg)!important; border:3px inset var(--pc-border);
      box-shadow:inset 0 0 10px #00e0ff22; font-family:'VT323', monospace; font-size:16px; outline:none; border-radius:0; caret-color:var(--pc-fg);
    }
    #public-chat input.chat-input:focus, #public-chat textarea.chat-input:focus{box-shadow:inset 0 0 10px #00e0ff55, 0 0 6px #00e0ff55}
    #public-chat ::placeholder{color:#c8d0ffbb}
    #public-chat #pcSend.btn{border:3px outset #58f!important; background:#001a5e!important; color:#e6e6ff!important; text-transform:uppercase; font-weight:bold; box-shadow:inset 0 0 10px #00e0ff44, 0 0 6px var(--pc-shadow)}
    #public-chat #pcSend.btn:hover{filter:brightness(1.15); border-style:inset}
    #pcFeed{background:#0d0130; color:#e6e6ff; border:4px ridge #8bf; font-family:'VT323', monospace; line-height:1.15}
    #public-chat .chat-item{background:#0b0022; border:3px groove #8bf; padding:10px; font-family:'VT323', monospace; white-space:pre-wrap}
    #public-chat .chat-head{gap:8px; align-items:baseline; flex-wrap:wrap}
    #public-chat .chat-name{color:#fffd37}
    #public-chat .chat-time{opacity:.8; font-size:12px}
    #pcFeed::-webkit-scrollbar{width:12px}
    #pcFeed::-webkit-scrollbar-track{background:#060015; border-left:2px ridge #59e}
    #pcFeed::-webkit-scrollbar-thumb{background:#001a5e; border:3px outset #58f; box-shadow:0 0 10px #00e0ff44}

    /* === MUSHROOM FX === */
    #mushroomFX{position:fixed; inset:0; z-index:1; pointer-events:none; image-rendering:pixelated; image-rendering:crisp-edges}

    /* === PIXEL CRT TV (bottom-left overlay) === */
    #pixelTV{
      position:fixed; left:10px; bottom:10px; z-index:5;
      width:min(30vmin,280px); aspect-ratio:4/3; pointer-events:none;
      filter: drop-shadow(0 0 10px rgba(0,224,255,.35)) drop-shadow(0 0 18px rgba(255,0,212,.25));
    }
    #pixelTV canvas{ width:100%; height:100%; image-rendering:pixelated; image-rendering:crisp-edges; display:block; }
    @media (max-width:780px){ #pixelTV{ left:6px; bottom:6px; width:min(34vmin,220px); } }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce){
      .title{ animation: none !important; }
      #bgDancer img{ animation: none !important; }
      .eye{ animation: none !important; }
    }

    /* Optional: lighter mobile mode */
    @media (max-width: 680px){
      #lavaBg{ display:none; }
      body::before, body::after{ display:none; }
    }

    /* Pause heavy canvases when tab hidden */
    body[data-paused="true"] #mushroomFX,
    body[data-paused="true"] #tvCRT{ visibility: hidden; }

    /* Auto performance mode — hide most expensive when FPS dips */
    :root[data-lowfps="true"] #lavaBg{ display:none !important; }
    :root[data-lowfps="true"] body::before,
    :root[data-lowfps="true"] body::after{ display:none !important; }
    :root[data-lowfps="true"] #pixelTV{ filter:none !important; }
  </style>
</head>

<body>
  <div id="lavaBg" aria-hidden="true"></div>

  <!-- floating eyes -->
  <div id="weirdLayer"></div>

  <!-- BACKGROUND MUSHROOMS -->
  <canvas id="mushroomFX"></canvas>

  <!-- Background dancing character -->
  <div id="bgDancer"><img src="img/dancer.png" alt="THE KID IN THE BOX — dancing" loading="lazy" decoding="async"/></div>

  <!-- Pixel CRT TV overlay -->
  <div id="pixelTV" aria-hidden="true">
    <canvas id="tvCRT" width="160" height="120"></canvas>
  </div>

  <div class="frame">
    <header>
      <h1 class="title">THE KID IN THE BOX</h1>
      <div class="news">
        <marquee behavior="scroll" scrollamount="6" direction="left">
          <span class="blink">★</span> NEW SINGLE OUT NOW — STREAM ON ALL PLATFORMS — FOLLOW FOR MORE MUSIC —
          <span class="blink">★</span>
        </marquee>
      </div>
    </header>

    <div class="grid">
      <nav>
        <h3>Social</h3>
        <a class="btn" href="https://open.spotify.com/artist/7JpTAHbGdFebyxNMvQgqTG?si=CkjcJ_lWQYm6hwVXGK9-9g" target="_blank" rel="noopener">Spotify</a>
        <a class="btn" href="https://music.apple.com/au/artist/the-kid-in-the-box/1793599382" target="_blank" rel="noopener">Apple Music</a>
        <a class="btn" href="https://www.youtube.com/@thekidinthebox?si=Gh7D2dWkX7tai-Fq" target="_blank" rel="noopener">YouTube</a>
        <a class="btn" href="https://instagram.com/thekidinthebox/" target="_blank" rel="noopener">Instagram</a>
        <a class="btn" href="mailto:alaahero88@gmail.com" target="_blank" rel="noopener">Email</a>

        <h3>Goodies</h3>
        <a class="btn" href="#shows">Shows</a>
        <a class="btn" href="#music">Music</a>
        <a class="btn" href="#arcade">Arcade</a>
        <a class="btn" href="#public-chat">Public Chat</a>
        <a class="btn" href="#gallery">Gallery</a>
        <a class="btn" href="#contact">Contact</a>

        <p style="margin-top:14px">Visitors: <span id="counter" class="counter">000001</span></p>
      </nav>

      <main>
        <section class="card" id="intro">
          <h2 style="font-family:'Press Start 2P', monospace; font-size:18px">Welcome to my BOX</h2>
          <p> <em></em>. Click around, play the tunes, </p>
          <p>Music should auto-start after your first click/tap. Use the control at the top-right.</p>
        </section>

        <section class="card" id="music">
          <h2>Featured Track</h2>
          <audio id="player" preload="auto" src="music.mp3"></audio>
          <p>check out my music it is really good.</p>
          <div style="border:4px ridge #8bf; box-shadow:0 0 25px #00e0ff55; background:#0d0130; padding:6px;">
            <iframe width="100%" height="315" loading="lazy"
              src="https://www.youtube.com/embed/iCsEXdCGPag"
              title="THE KID IN THE BOX — Official Music Video" frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen></iframe>
          </div>
        </section>

        <section class="card" id="shows">
          <h2>Shows</h2>
          <ul>
            <li> — Melbourne, Secret House Party (DM for address)</li>
          </ul>
        </section>

        <!-- === ARCADE: Pixel Blaster === -->
        <section class="card" id="arcade">
          <h2>🕹️ Pixel Blaster</h2>
          <p>Move with <strong>A/D</strong> or <strong>←/→</strong>, shoot with <strong>SPACE</strong>, pause with <strong>P</strong>. Survive and score!</p>
          <div class="pixel-wrapper">
            <canvas id="pxCanvas" width="320" height="180"></canvas>
          </div>
          <div style="margin-top:8px; display:flex; gap:12px; align-items:center; flex-wrap:wrap">
            <span>Score: <span id="pxScore">0</span></span>
            <span>Lives: <span id="pxLives">3</span></span>
            <span>Level: <span id="pxLevel">1</span></span>
            <button id="pxStart" class="btn" type="button">Start</button>
          </div>
        </section>

        <!-- === PUBLIC CHAT === -->
        <section class="card" id="public-chat">
          <h2>🗣️ Public Chat — share your feelings</h2>
          <div style="display:grid; gap:8px; max-width:720px">
            <input id="pcName" class="chat-input" placeholder="Your name (or nickname)" maxlength="24" />
            <textarea id="pcText" class="chat-input" rows="3" placeholder="What are you feeling right now?" maxlength="300"></textarea>
            <div style="display:flex; gap:8px; align-items:center">
              <button class="btn" id="pcSend" type="button">Post</button>
              <small id="pcHint" style="opacity:.8">Be kind... Max 300 chars. No login needed.</small>
            </div>
          </div>
          <div id="pcFeed" style="margin-top:14px; max-height:380px; overflow:auto; display:grid; gap:10px; border:4px ridge #8bf; padding:10px; background:#0d0130;"></div>
        </section>

        <section class="card" id="gallery">
          <h2>Gallery</h2>
          <p>here some cute pictures of me</p>
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:10px">
            <img src="img/1.png" alt="retro" style="width:100%; border:4px outset #69f" loading="lazy" decoding="async"/>
            <img src="img/2.png" alt="retro" style="width:100%; border:4px outset #69f" loading="lazy" decoding="async"/>
            <img src="img/3.png" alt="retro" style="width:100%; border:4px outset #69f" loading="lazy" decoding="async"/>
          </div>
        </section>

        <section class="card" id="contact">
          <h2>Contact</h2>
          <p>For bookings/collabs: <a href="mailto:alaahero88@gmail.com">alaahero88@gmail.com</a></p>
        </section>
      </main>
    </div>

    <footer>
      <p>© <span id="year"></span> ALHUR — Made with ✨ and a lot of <span class="blink">&lt;marquee&gt;</span>.</p>
    </footer>
  </div>

  <!-- Floating music control -->
  <button id="musicBtn" title="Play/Pause" style="position:fixed; top:14px; right:14px; z-index:9999; border:3px outset #58f; background:#001a5e; color:#e6e6ff; padding:10px 12px; font-weight:bold; text-transform:uppercase; box-shadow: inset 0 0 10px #00e0ff44, 0 0 6px #00e0ff55;">▶ Music</button>

  <!-- Volume slider -->
  <input id="volCtrl" type="range" min="15" max="100" value="35"
    title="Volume" style="position:fixed; top:14px; right:110px; z-index:9999; width:130px; accent-color:#58f">

  <!-- ========== PERFORMANCE KNOBS ========== -->
  <script>
    const PERF = {
      maxFPS: 30,                 // cap background canvases
      tvFPS: 20,                  // CRT TV frames
      dpr: 1,                     // heavy canvases DPR
      shroomDensityDivisor: 50000,// fewer mushrooms (higher = fewer)
      sparkleMinGapMs: 80,        // throttle sparkle
      eyesCount: 8,               // fewer eyes
      tvStaticEvery: 2            // update TV noise every N frames
    };
    if (navigator.deviceMemory && navigator.deviceMemory <= 4) {
      PERF.maxFPS = 24; PERF.tvFPS = 16; PERF.tvStaticEvery = 3;
    }
    if ('connection' in navigator && navigator.connection.saveData) {
      PERF.maxFPS = 20; PERF.tvFPS = 12; PERF.tvStaticEvery = 4;
    }
    document.addEventListener('visibilitychange', () => {
      document.body.toggleAttribute('data-paused', document.hidden);
    });
  </script>

  <!-- ========== GLOBAL RAF BUS (single animation clock) ========== -->
  <script>
    const RafBus = (() => {
      let subs = new Set(), running = false, last = performance.now();
      function loop(now){
        const dt = now - last; last = now;
        subs.forEach(fn => { try{ fn(now, dt); }catch(e){} });
        if (document.hidden) { running = false; return; }
        requestAnimationFrame(loop);
      }
      return {
        subscribe(fn){ subs.add(fn); if(!running){ running=true; requestAnimationFrame(loop); } return () => subs.delete(fn); }
      };
    })();

    // Auto low-FPS detector → enable degrade mode
    (function(){
      let bad = 0;
      RafBus.subscribe((_, dt) => {
        if (dt > 28) bad++; else bad = Math.max(0, bad-1);
        const low = bad > 6;
        document.documentElement.toggleAttribute('data-lowfps', low);
      });
    })();
  </script>

  <!-- Core UI scripts -->
  <script>
    // Year
    document.getElementById('year').textContent = new Date().getFullYear();

    // Fake hit counter
    (function(){
      const key='alhur-counter-v1';
      const n=(Number(localStorage.getItem(key))||1)+Math.floor(Math.random()*3+1);
      localStorage.setItem(key,n);
      const el=document.getElementById('counter');
      if(el) el.textContent=String(n).padStart(6,'0');
    })();

    // Music control + volume memory
    const player=document.getElementById('player');
    const btn=document.getElementById('musicBtn');
    const volCtrl=document.getElementById('volCtrl');

    function setVolume(v){const c=Math.min(1,Math.max(0.15,v)); if(player){player.volume=c;} if(volCtrl) volCtrl.value=Math.round(c*100); localStorage.setItem('site-vol',String(c));}
    const savedVol=Number(localStorage.getItem('site-vol')); if(!Number.isNaN(savedVol)) setVolume(savedVol); else setVolume(0.5);
    volCtrl?.addEventListener('input',()=>setVolume(volCtrl.value/100));
    player?.addEventListener('volumechange',()=>{ if(player.volume<0.15) setVolume(0.15); });

    let interacted=false;
    function playPause(){ if(!player) return; if(player.paused){ player.play().catch(()=>{}); btn.textContent='❚❚ Pause'; } else{ player.pause(); btn.textContent='▶ Music'; } }
    btn.addEventListener('click',()=>{ interacted=true; playPause(); });
    window.addEventListener('pointerdown',()=>{ if(!interacted&&player){ interacted=true; player.play().catch(()=>{}); btn.textContent='❚❚ Pause'; } },{once:true});
    player?.addEventListener('ended',()=>{ player.currentTime=0; player.play().catch(()=>{}); });

    // Sync dancer with music
    const dancerWrap=document.getElementById('bgDancer');
    function syncDancer(){ if(!dancerWrap||!player) return; document.body.classList.toggle('playing',!player.paused); }
    player?.addEventListener('play',syncDancer);
    player?.addEventListener('pause',syncDancer);
    window.addEventListener('load',syncDancer);

    // Mouse sparkle (throttled)
    (function(){
      const colors=['#ff00d4','#00ffea','#fffd37'];
      let lastT = 0;
      window.addEventListener('mousemove',(e)=>{
        const now = performance.now();
        if(now - lastT < PERF.sparkleMinGapMs) return;
        lastT = now;
        const s=document.createElement('div');
        s.className='sparkle';
        s.style.left=(e.clientX-3)+'px';
        s.style.top=(e.clientY-3)+'px';
        s.style.background=colors[Math.random()*colors.length|0];
        s.style.boxShadow='0 0 12px currentColor, 0 0 24px currentColor';
        document.body.appendChild(s);
        requestAnimationFrame(()=>{ s.style.transition='all .6s ease-out'; s.style.transform='translateY(-12px) scale(0)'; s.style.opacity='0'; });
        setTimeout(()=> s.remove(),700);
      }, {passive:true});
    })();

    document.addEventListener('contextmenu',(e)=>{ e.preventDefault(); alert('No stealing my pixels! (jk)\n— Harry G'); });
  </script>

  <!-- === Pixel Blaster (now using RafBus) === -->
  <script>
  (function(){
    const view=document.getElementById('pxCanvas'); if(!view) return;
    const scoreEl=document.getElementById('pxScore');
    const livesEl=document.getElementById('pxLives');
    const levelEl=document.getElementById('pxLevel');
    const startBtn=document.getElementById('pxStart');

    const w=view.width, h=view.height;
    const ctx=view.getContext('2d');

    const ONE_HIT_DEATH=true, PLAYER_SPEED=190, PLAYER_COOLDOWN_FRAMES=4, ENEMY_BASE_SPEED=12, ENEMY_FIRE_BASE=0.010, ENEMY_BULLET_SPEED=120, ENEMY_AIMING=0.45;

    let playing=false, paused=false, frame=0, score=0, lives=ONE_HIT_DEATH?1:3, level=1;
    const keys={left:false,right:false,shoot:false};
    const player={x:w/2,y:h-18,vx:0,speed:PLAYER_SPEED,cooldown:0,blink:0};
    const bullets=[], eBullets=[], enemies=[];
    const stars=Array.from({length:80},()=>({x:Math.random()*w,y:Math.random()*h,s:Math.random()*1.5+0.5}));
    let unsubGame = null;

    function resetRound(){
      bullets.length=0; eBullets.length=0; enemies.length=0;
      const count=7+level;
      for(let i=0;i<count;i++){
        enemies.push({x:20+i*((w-40)/count)+(Math.random()*6-3), y:22+Math.random()*16, vx:(Math.random()<0.5?-1:1)*(ENEMY_BASE_SPEED+level*2), hp:1, cooldown:Math.floor(Math.random()*60)});
      }
    }

    function start(){
      playing=true; paused=false; score=0; lives=ONE_HIT_DEATH?1:3; level=1; frame=0;
      player.x=w/2; player.cooldown=0; player.blink=0; resetRound();
      startBtn.textContent='Playing…'; startBtn.disabled=true;
      if(!unsubGame){
        unsubGame = RafBus.subscribe(loop);
      }
    }
    function stop(){
      playing=false;
      startBtn.textContent='Restart'; startBtn.disabled=false;
    }
    function nextLevel(){ level++; levelEl.textContent=level; resetRound(); }

    window.addEventListener('keydown',(e)=>{ if(e.key==='a'||e.key==='ArrowLeft') keys.left=true; if(e.key==='d'||e.key==='ArrowRight') keys.right=true; if(e.code==='Space'){ keys.shoot=true; e.preventDefault(); } if(e.key.toLowerCase()==='p') paused=!paused; });
    window.addEventListener('keyup',(e)=>{ if(e.key==='a'||e.key==='ArrowLeft') keys.left=false; if(e.key==='d'||e.key==='ArrowRight') keys.right=false; if(e.code==='Space') keys.shoot=false; });

    function fire(){ if(player.cooldown>0) return; bullets.push({x:player.x,y:player.y-6,vy:-300}); player.cooldown=PLAYER_COOLDOWN_FRAMES; }
    function enemyFire(ex,ey){ const dx=player.x-ex, dy=player.y-ey, len=Math.hypot(dx,dy)||1; const ax=(1-ENEMY_AIMING)*0+ENEMY_AIMING*(dx/len), ay=(1-ENEMY_AIMING)*1+ENEMY_AIMING*(dy/len), s=ENEMY_BULLET_SPEED+level*10; eBullets.push({x:ex,y:ey+4,vx:ax*s,vy:ay*s}); }

    function loop(_, dt){
      if(!playing) return;
      if(paused || document.body.hasAttribute('data-paused')) { draw(true); return; }

      const step = Math.min(1/30, dt/1000); // cap to avoid huge jumps
      frame++;

      player.vx=(keys.right?1:0)-(keys.left?1:0);
      player.x=Math.max(8,Math.min(w-8,player.x+player.vx*PLAYER_SPEED*step));
      if(keys.shoot) fire();
      if(player.cooldown>0) player.cooldown--;
      if(player.blink>0) player.blink--;

      bullets.forEach(b=> b.y+=b.vy*step);
      for(let i=bullets.length-1;i>=0;i--) if(bullets[i].y<-6) bullets.splice(i,1);

      enemies.forEach(e=>{
        e.x+=e.vx*step;
        if(e.x<8||e.x>w-8) e.vx*=-1;
        e.y+=Math.sin((frame+e.x)*0.03)*0.1;
        if(e.cooldown>0) e.cooldown--;
        const aligned=Math.abs(e.x-player.x)<10?0.02:0;
        if(e.cooldown===0 && Math.random()<(ENEMY_FIRE_BASE+level*0.002+aligned)){
          enemyFire(e.x,e.y);
          e.cooldown=40+Math.floor(Math.random()*40)-Math.min(level*2,20);
          if(e.cooldown<10) e.cooldown=10;
        }
      });

      eBullets.forEach(b=>{ b.x+=b.vx*step; b.y+=b.vy*step; });
      for(let i=eBullets.length-1;i>=0;i--){ const b=eBullets[i]; if(b.y>h+4||b.y<-4||b.x>w+4||b.x<-4) eBullets.splice(i,1); }

      for(let i=enemies.length-1;i>=0;i--){
        const e=enemies[i];
        if(e.y>=h-24){ enemies.splice(i,1); damage(); continue; }
        for(let j=bullets.length-1;j>=0;j--){
          const b=bullets[j];
          if(Math.abs(b.x-e.x)<6 && Math.abs(b.y-e.y)<6){
            bullets.splice(j,1); e.hp-=1; score+=10; scoreEl.textContent=score;
            if(e.hp<=0) enemies.splice(i,1);
            break;
          }
        }
      }
      for(let i=eBullets.length-1;i>=0;i--){
        const b=eBullets[i], hw=3, hh=5;
        const nx=Math.max(player.x-hw,Math.min(b.x,player.x+hw));
        const ny=Math.max(player.y-hh,Math.min(b.y,player.y+hh));
        const dx=b.x-nx, dy=b.y-ny;
        if(dx*dx+dy*dy<=16){ eBullets.splice(i,1); damage(true); break; }
      }

      if(enemies.length===0){ score+=100; scoreEl.textContent=score; nextLevel(); }
      stars.forEach(s=>{ s.y+=s.s*0.6; if(s.y>h){ s.y=-2; s.x=Math.random()*w; } });

      draw(false);
    }

    function damage(fromBullet=false){
      if(ONE_HIT_DEATH||fromBullet){ lives=0; livesEl.textContent=lives; return gameOver('YOU LOST!'); }
      if(player.blink>0) return;
      lives--; livesEl.textContent=lives;
      if(lives<=0){ gameOver('YOU LOST!'); } else { player.x=w/2; player.blink=90; }
    }
    function gameOver(msg){
      stop();
      const ctx=view.getContext('2d');
      ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(0,0,w,h);
      ctx.fillStyle='#d24dff'; ctx.font='20px VT323, monospace'; ctx.fillText(msg||'YOU LOST!',96,72);
      ctx.fillStyle='#e6e6ff'; ctx.font='16px VT323, monospace';
      ctx.fillText('GAME OVER',110,94); ctx.fillText('Score: '+score,118,112); ctx.fillText('Press Start to play again',54,134);
    }
    function draw(pausedOverlay){
      const ctx=view.getContext('2d');
      ctx.fillStyle='#080016'; ctx.fillRect(0,0,w,h);
      ctx.fillStyle='#7cf9ff'; stars.forEach(s=> ctx.fillRect(Math.floor(s.x),Math.floor(s.y),1,1));
      if(!(player.blink>0 && Math.floor(frame/6)%2===0)){
        ctx.fillStyle='#ff00d4'; const px=Math.floor(player.x), py=Math.floor(player.y);
        const ship=[[0,1,0],[1,1,1],[0,1,0],[1,1,1],[0,1,0]];
        for(let r=0;r<ship.length;r++) for(let c=0;c<ship[r].length;c++) if(ship[r][c]) ctx.fillRect(px-3+c*2, py-5+r*2, 2, 2);
      }
      ctx.fillStyle='#fffd37'; bullets.forEach(b=> ctx.fillRect(Math.floor(b.x)-1, Math.floor(b.y)-3, 2, 3));
      enemies.forEach(e=>{ const ex=Math.floor(e.x),ey=Math.floor(e.y); ctx.fillStyle='#00ffea'; ctx.fillRect(ex-4,ey-3,8,6); ctx.fillStyle='#080016'; ctx.fillRect(ex-2,ey-1,1,1); ctx.fillRect(ex+1,ey-1,1,1); });
      ctx.fillStyle='#d24dff'; eBullets.forEach(b=>{ ctx.beginPath(); ctx.arc(b.x|0, b.y|0, 4, 0, Math.PI*2); ctx.fill(); });
      if(pausedOverlay){ ctx.fillStyle='rgba(0,0,0,.5)'; ctx.fillRect(0,0,w,h); ctx.fillStyle='#e6e6ff'; ctx.font='16px VT323, monospace'; ctx.fillText('PAUSED (press P)',96,92); }
    }

    document.getElementById('pxStart').addEventListener('click',()=>{ if(!playing) start(); });
    scoreEl.textContent=score; livesEl.textContent=lives; levelEl.textContent=level;
  })();
  </script>

  <!-- Floating weird eyes (uses PERF.eyesCount) -->
  <script>
    (function(){
      const host=document.getElementById('weirdLayer'); const COUNT = (window.PERF && PERF.eyesCount) ? PERF.eyesCount : 10; const eyes=[];
      function spawn(){ for(let i=0;i<COUNT;i++){ const eye=document.createElement('div'); eye.className='eye';
        eye.style.left=(Math.random()*100)+'%'; eye.style.top=(Math.random()*100)+'%'; eye.style.setProperty('--rot',(Math.random()*8-4)+'deg'); eye.style.animationDelay=(Math.random()*4)+'s';
        const scl=document.createElement('div'); scl.className='sclera'; const pup=document.createElement('div'); pup.className='pupil'; eye.appendChild(scl); eye.appendChild(pup); host.appendChild(eye); eyes.push({eye,pup}); } }
      spawn();
      function track(e){ const mx=e.clientX,my=e.clientY; eyes.forEach(({eye,pup})=>{ const r=eye.getBoundingClientRect(); const cx=r.left+r.width/2, cy=r.top+r.height/2;
        const dx=mx-cx, dy=my-cy; const mag=Math.min(10, Math.hypot(dx,dy)/10); const a=Math.atan2(dy,dx); pup.style.setProperty('--x',(Math.cos(a)*mag)+'px'); pup.style.setProperty('--y',(Math.sin(a)*mag)+'px'); }); }
      window.addEventListener('mousemove',track, {passive:true});
    })();
  </script>

  <!-- Firebase libs deferred -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <!-- Firebase (batched feed rendering) -->
  <script>
    window.addEventListener('load', () => {
      try{
        const firebaseConfig={apiKey:"AIzaSyDTDgv-kqr1GSWguVUBP5NDZvc5U4Z1jSw",authDomain:"kid-in-the-box.firebaseapp.com",projectId:"kid-in-the-box",appId:"513322178741:web:555149700b0a3e5d7a46fc"};
        if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db=firebase.firestore();
        const pcName=document.getElementById('pcName'), pcText=document.getElementById('pcText'), pcSend=document.getElementById('pcSend'), pcFeed=document.getElementById('pcFeed'), pcHint=document.getElementById('pcHint');
        if(!db || !pcName || !pcText || !pcSend || !pcFeed) return;

        pcName.value=localStorage.getItem('public-chat-name')||''; pcName.addEventListener('input',()=>localStorage.setItem('public-chat-name',pcName.value));
        function pcCanPost(){ const last=Number(localStorage.getItem('public-chat-last')||0); return (Date.now()-last)>15000; }
        function pcMarkPosted(){ localStorage.setItem('public-chat-last',Date.now()); }
        function pcRender(d){ const wrap=document.createElement('div'); wrap.className='chat-item'; const head=document.createElement('div'); head.className='chat-head';
          const name=document.createElement('span'); name.className='chat-name'; name.textContent=d.name||'Anon';
          const time=document.createElement('span'); time.className='chat-time'; const t=d.createdAt?.toDate?d.createdAt.toDate():new Date(); time.textContent='• '+t.toLocaleString();
          head.appendChild(name); head.appendChild(time); const body=document.createElement('p'); body.style.margin='6px 0 0'; body.textContent=d.text||''; wrap.appendChild(head); wrap.appendChild(body); return wrap; }

        // Batch UI updates (don’t re-render on every snapshot chunk)
        let pcQueue = [];
        db.collection('publicChat').orderBy('createdAt','desc').limit(100)
          .onSnapshot(snap => { pcQueue = []; snap.forEach(doc => pcQueue.push(doc.data())); });

        RafBus.subscribe(() => {
          if(!pcQueue.length) return;
          const frag = document.createDocumentFragment();
          pcQueue.forEach(d => frag.appendChild(pcRender(d)));
          pcFeed.innerHTML = '';
          pcFeed.appendChild(frag);
          pcQueue = [];
        });

        pcSend.addEventListener('click', async ()=>{ const name=pcName.value.trim().slice(0,24); const text=pcText.value.trim().slice(0,300);
          if(!name||!text){ pcHint.textContent='Please enter a name and a message.'; return; }
          if(!pcCanPost()){ pcHint.textContent='You can post again in a few seconds…'; return; }
          await db.collection('publicChat').add({name,text,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
          pcText.value=''; pcMarkPosted(); pcHint.textContent='Sent ✔'; setTimeout(()=> pcHint.textContent='Be kind. Max 300 chars. No login needed.',2000);
        });
      }catch(e){ console.warn('Public chat init skipped:', e); }
    });
  </script>

  <!-- ========== MUSHROOM FX (optimized + RafBus) ========== -->
  <script>
    (function(){
      const c=document.getElementById('mushroomFX'); const ctx=c.getContext('2d');
      const DPR = PERF.dpr;
      let W=0,H=0,SHROOMS=[]; let acc=0, interval=1000/Math.max(12, PERF.maxFPS);

      function size(){
        W=Math.floor(innerWidth*DPR); H=Math.floor(innerHeight*DPR);
        c.width=W; c.height=H; c.style.width=innerWidth+'px'; c.style.height=innerHeight+'px';
      }
      function makeShroom(){ const s=(Math.random()*2+1)|0; return { x:Math.random()*W, y:Math.random()*H, s:(s+1), sway:Math.random()*Math.PI*2, speed:(0.06+Math.random()*0.16)*DPR, phase:Math.random()*Math.PI*2, hue:Math.random()<0.5?'#ff00d4':'#00ffea' }; }
      function pixelCap(x,y,scale,color){ ctx.fillStyle=color; const pat=["00111000","01111100","11111110","11111110","01111100"];
        for(let r=0;r<pat.length;r++){ for(let c2=0;c2<pat[r].length;c2++){ if(pat[r][c2]==='1'){ ctx.fillRect(x+c2*scale,y+r*scale,scale,scale); } } }
        ctx.fillStyle='#e6e6ff'; ctx.fillRect(x+3*scale,y+2*scale,scale,scale);
        ctx.fillStyle='#ffd6b3'; for(let r=0;r<5;r++) ctx.fillRect(x+3*scale,y+5*scale+r*scale,2*scale,scale);
      }
      function init(){ size(); SHROOMS.length=0; const count=Math.round((innerWidth*innerHeight)/PERF.shroomDensityDivisor); for(let i=0;i<count;i++) SHROOMS.push(makeShroom()); }
      function step(now){
        ctx.clearRect(0,0,W,H);
        for(const m of SHROOMS){
          const swayX=Math.sin(m.sway+now*0.0006)*10*DPR;
          const bobY=Math.sin(m.phase+now*0.0008)*6*DPR;
          m.x+=Math.cos(m.sway)*0.04*DPR; m.y-=m.speed;
          if(m.y<-20*DPR){ m.y=H+20*DPR; m.x=Math.random()*W; }
          pixelCap((m.x+swayX)|0, (m.y+bobY)|0, m.s, m.hue);
        }
      }
      addEventListener('resize',init); init();

      RafBus.subscribe((now, dt) => {
        if (document.body.hasAttribute('data-paused')) return;
        acc += dt;
        if (acc >= interval) { step(now); acc = 0; }
      });
    })();
  </script>

  <!-- ========== Pixel CRT TV renderer (optimized + RafBus) ========== -->
  <script>
    (function(){
      const canvas = document.getElementById('tvCRT'); if(!canvas) return;
      const ctx = canvas.getContext('2d', { alpha: true });
      const W = canvas.width, H = canvas.height;
      const screen = { x: 20, y: 18, w: 120, h: 84 };
      let t = 0, acc=0, interval = 1000/Math.max(12, PERF.tvFPS);

      function px(x,y,w,h,c){ ctx.fillStyle=c; ctx.fillRect(x|0,y|0,w|0,h|0); }

      function drawChassis(){
        ctx.imageSmoothingEnabled = false; ctx.clearRect(0,0,W,H);
        px(4, 94, 152, 22, 'rgba(0,0,0,0.35)');
        for(let y=8;y<100;y+=2){ px(4,y,10,2, y%4?'#4b2b17':'#5a341d'); px(W-14,y,10,2, y%4?'#4b2b17':'#5a341d'); }
        px(10,6,140,100,'#2b2b31'); px(10,6,140,1,'#4a4a56'); px(10,105,140,1,'#111');
        px(10,6,1,100,'#4a4a56'); px(149,6,1,100,'#111');
        px(16,12,128,88,'#14141a'); px(12,8,2,2,'#7b7b86'); px(146,8,2,2,'#7b7b86');
        px(12,104,2,2,'#7b7b86'); px(146,104,2,2,'#7b7b86');
        for(let y=18;y<92;y+=3){ for(let x=146;x<154;x+=3){ px(x-6,y,1,1,'#0b0b10'); } }
        px(138,20,8,8,'#222'); px(139,21,6,6,'#3a3a3a');
        px(138,32,8,8,'#222'); px(139,33,6,6,'#3a3a3a');
        px(22,108,12,6,'#1a1a1f'); px(126,108,12,6,'#1a1a1f');
        for(let i=0;i<8;i++){ px(84+i,4-i,1,1,'#61616b'); px(76-i,4-i,1,1,'#61616b'); } px(80,6,2,2,'#777');
      }

      const grad = (() => {
        const g = ctx.createRadialGradient(screen.x+screen.w/2, screen.y+screen.h/2, 4, screen.x+screen.w/2, screen.y+screen.h/2, screen.w);
        g.addColorStop(0,'rgba(0,0,0,0)');
        g.addColorStop(1,'rgba(0,0,0,0.55)');
        return g;
      })();

      let seed = 1337; function rnd(){ seed = (seed*1103515245 + 12345) & 0x7fffffff; return (seed>>16) & 0xff; }

      const off = document.createElement('canvas'); off.width=screen.w; off.height=screen.h;
      const octx = off.getContext('2d', { alpha: true }); octx.imageSmoothingEnabled=false;

      function drawStatic(updateFull){
        octx.clearRect(0,0,off.width,off.height);
        const jx = ((t&1)?1:0), jy = 0;
        octx.fillStyle = '#0c0f14'; octx.fillRect(0,0,off.width,off.height);

        if (updateFull){
          const img = octx.createImageData(off.width, off.height);
          const data = img.data;
          for(let y=0;y<off.height;y++){
            for(let x=0;x<off.width;x++){
              const idx=(y*off.width+x)<<2;
              const g = 24 + (rnd()%48) + ((y&1)?6:0);
              data[idx]=data[idx+1]=data[idx+2]=g; data[idx+3]=255;
            }
          }
          octx.putImageData(img, 0, 0);
          octx.fillStyle='rgba(0,0,0,0.25)';
          for(let y=0;y<off.height;y+=2){ octx.fillRect(0,y,off.width,1); }
        }

        octx.font = '12px "Press Start 2P", VT323, monospace';
        octx.textAlign = 'center'; octx.textBaseline = 'middle';
        octx.fillStyle = '#fffd37';
        octx.fillText('THE KID', off.width/2 + jx, 26 + jy);
        octx.fillText('IN THE', off.width/2 - jx, 50 + jy);
        octx.fillText('BOX',     off.width/2 + jx, 74 + jy);

        octx.globalCompositeOperation='lighter';
        octx.drawImage(off, 1, 0); octx.drawImage(off, 0, 1);
        octx.globalCompositeOperation='source-over';

        ctx.imageSmoothingEnabled=false;
        drawChassis();
        ctx.drawImage(off, screen.x, screen.y);
        ctx.fillStyle = grad; ctx.fillRect(screen.x, screen.y, screen.w, screen.h);
        ctx.globalCompositeOperation='lighter';
        px(screen.x-2, screen.y-2, screen.w+4, screen.h+4, 'rgba(0,224,255,0.05)');
        ctx.globalCompositeOperation='source-over';
      }

      RafBus.subscribe((now, dt) => {
        if (document.body.hasAttribute('data-paused')) return;
        acc += dt;
        if (acc >= interval){
          t++; const updateStatic = (t % PERF.tvStaticEvery) === 0;
          drawStatic(updateStatic);
          acc = 0;
        }
      });
    })();
  </script>
</body>
</html>
